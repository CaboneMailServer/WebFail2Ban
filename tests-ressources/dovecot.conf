# Dovecot configuration for testing fail2ban integration

# Protocols we want to be serving
protocols = imap imaps pop3 pop3s

# Base directory where to store runtime data
base_dir = /var/run/dovecot/

# Mail location
mail_location = maildir:/var/mail/%u/Maildir

# Authentication
auth_mechanisms = plain login

# User database
userdb {
  driver = passwd-file
  args = username_format=%n /etc/dovecot/users
}

# Password database
passdb {
  driver = passwd-file
  args = username_format=%n /etc/dovecot/users
}

# SSL settings
ssl = yes
ssl_cert = </etc/ssl/certs/dovecot.crt
ssl_key = </etc/ssl/private/dovecot.key

# IMAP configuration
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

service imap {
  process_limit = 1024
}

# POP3 configuration
service pop3-login {
  inet_listener pop3 {
    port = 110
  }
  inet_listener pop3s {
    port = 995
    ssl = yes
  }
}

# Authentication debugging (for fail2ban testing)
auth_verbose = yes
auth_debug = yes
auth_debug_passwords = yes

# Logging configuration for fail2ban
log_path = /var/log/dovecot/dovecot.log
info_log_path = /var/log/dovecot/dovecot-info.log
debug_log_path = /var/log/dovecot/dovecot-debug.log

# Syslog facility
syslog_facility = mail

# Enable more verbose logging for failed authentication attempts
log_timestamp = "%Y-%m-%d %H:%M:%S "

# Mail processes
service auth {
  unix_listener auth-userdb {
    mode = 0600
    user = vmail
    group = vmail
  }

  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    user = postfix
    group = postfix
  }

  user = dovecot
}

# Default VSZ limit
default_vsz_limit = 256M

# Namespace configuration
namespace inbox {
  type = private
  separator = /
  prefix =
  location =
  inbox = yes
  hidden = no
  list = yes
  subscriptions = yes
}

# Protocol settings
protocol imap {
  mail_max_userip_connections = 10
}

protocol pop3 {
  pop3_uidl_format = %08Xu%08Xv
}

# Test users (for fail2ban testing)
# Create users file with test@example.com:password
# echo "test@example.com:{PLAIN}password:1001:1001::/var/mail/test@example.com::" > /etc/dovecot/users