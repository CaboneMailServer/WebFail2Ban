global
    daemon
    log stdout local0 info
    stats socket /var/run/haproxy.sock mode 600 level admin
    tune.ssl.default-dh-param 2048

# Frontend IMAP/IMAPS
frontend imap_frontend
    bind *:143
    bind *:993 ssl crt /etc/ssl/certs/mail.pem

    # Configuration SPOA pour vérification IP
    filter spoe engine ip-reputation config /usr/local/etc/haproxy/spoe-ip-reputation.conf
    tcp-request content track-sc0 src

    # Bloquer les IP bannies
    tcp-request content reject if { var(txn.banned) -m int eq 1 }

    default_backend dovecot_backend

# Frontend SMTP Submission (587) et SMTPS (465)
frontend smtp_frontend
    bind *:587
    bind *:465 ssl crt /etc/ssl/certs/mail.pem
    mode tcp

    # Configuration SPOA pour vérification IP
    filter spoe engine ip-reputation config /usr/local/etc/haproxy/spoe-ip-reputation.conf
    tcp-request content track-sc0 src

    # Bloquer les IP bannies
    tcp-request content reject if { var(txn.banned) -m int eq 1 }

    default_backend postfix_backend

# Frontend SOGo HTTP/HTTPS
frontend sogo_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/mail.pem
    mode http

    # Configuration SPOA pour vérification IP
    filter spoe engine ip-reputation config /usr/local/etc/haproxy/spoe-ip-reputation.conf
    http-request track-sc0 src

    # Bloquer les IP bannies
    http-request deny if { var(txn.banned) -m int eq 1 }

    # Redirection HTTP vers HTTPS
    redirect scheme https if !{ ssl_fc }

    # Headers de sécurité
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"

    # Routes SOGo
    acl is_sogo_path path_beg /SOGo
    acl is_sogo_api path_beg /Microsoft-Server-ActiveSync
    acl is_sogo_dav path_beg /.well-known/caldav
    acl is_sogo_dav path_beg /.well-known/carddav

    use_backend sogo_backend if is_sogo_path or is_sogo_api or is_sogo_dav
    default_backend sogo_backend

# Backend Dovecot IMAP
backend dovecot_backend
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    server dovecot1 dovecot:143 check inter 5s
    server dovecot2 dovecot:993 check ssl verify none inter 5s

# Backend Postfix SMTP
backend postfix_backend
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    server postfix1 postfix:587 check inter 5s
    server postfix2 postfix:465 check ssl verify none inter 5s

# Backend SOGo
backend sogo_backend
    mode http
    balance roundrobin
    option httpchk GET /SOGo.woa/so/SystemConfiguration
    http-check expect status 200

    # Headers pour SOGo
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Proto http if !{ ssl_fc }

    server sogo1 sogo:80 check inter 10s

# Backend SPOE
backend spoe-ip-reputation
    mode tcp
    timeout connect 5s
    timeout server 3s
    balance roundrobin
    server spoe1 fail2ban-haproxy:12345 check inter 5s

# Stats interface (optionnel)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE


